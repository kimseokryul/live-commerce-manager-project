

# ë¡œê·¸ë¥¼ í‘œì¤€ ì¶œë ¥ìœ¼ë¡œ, ë¡œê·¸ ë ˆë²¨ì€ info
error_log /dev/stdout info;

events {
    # ìµœëŒ€ ë™ì‹œ ì—°ê²° ìˆ˜
    worker_connections 1024;
}

# RTMP ì„¤ì • ë¸”ë¡
rtmp {
    server {
        listen 1935;                 # RTMP ìˆ˜ì‹  í¬íŠ¸ (OBSê°€ ì†¡ì¶œí•  í¬íŠ¸)
        chunk_size 4000;            # RTMP chunk í¬ê¸° (ê¸°ë³¸ê°’: 128, ë” í¬ë©´ ì„±ëŠ¥ í–¥ìƒ ê°€ëŠ¥)

        # OBSê°€ ì†¡ì¶œí•˜ëŠ” RTMP ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ìš©
        application stream {
            live on;                # ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í™œì„±í™”

            # ì†¡ì¶œëœ RTMP ìŠ¤íŠ¸ë¦¼ì„ ffmpegë¡œ ë°›ì•„ ë‹¤ì–‘í•œ í•´ìƒë„ë¡œ íŠ¸ëœìŠ¤ì½”ë”© í›„, hlsë¡œ ì¬ì†¡ì¶œ
            exec ffmpeg -i rtmp://localhost:1935/stream/$name
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 2500k -f flv -g 30 -r 30 -s 1280x720 -preset superfast -profile:v baseline rtmp://localhost:1935/hls/$name_720p2628kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 1000k -f flv -g 30 -r 30 -s 854x480 -preset superfast -profile:v baseline rtmp://localhost:1935/hls/$name_480p1128kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 750k  -f flv -g 30 -r 30 -s 640x360 -preset superfast -profile:v baseline rtmp://localhost:1935/hls/$name_360p878kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 400k  -f flv -g 30 -r 30 -s 426x240 -preset superfast -profile:v baseline rtmp://localhost:1935/hls/$name_240p528kbs
              -c:a libfdk_aac -b:a 64k  -c:v libx264 -b:v 200k  -f flv -g 15 -r 15 -s 426x240 -preset superfast -profile:v baseline rtmp://localhost:1935/hls/$name_240p264kbs;
        }

        # íŠ¸ëœìŠ¤ì½”ë”©ëœ HLS ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ìš©
        application hls {
            live on;                         # ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ
            hls on;                          # HLS í™œì„±í™”
            hls_fragment_naming system;      # ì¡°ê° íŒŒì¼ ì´ë¦„ì„ ì‹œìŠ¤í…œ ì‹œê°„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
            hls_fragment 5;                  # HLS ì¡°ê° íŒŒì¼ ê¸¸ì´ 5ì´ˆ
            hls_playlist_length 10;          # ì¬ìƒëª©ë¡ì— í¬í•¨ë  ì´ ê¸¸ì´ 10ì´ˆ
            hls_path /opt/data/hls;          # HLS ì¡°ê°(.ts)ê³¼ ì¬ìƒëª©ë¡(.m3u8) ì €ì¥ ê²½ë¡œ
            hls_nested on;                   # í´ë” êµ¬ì¡° ë¶„í•  ì‚¬ìš© (ìŠ¤íŠ¸ë¦¼ë³„ë¡œ ë””ë ‰í„°ë¦¬ ìƒì„±)

            # ì—¬ëŸ¬ í•´ìƒë„ì˜ HLS ìŠ¤íŠ¸ë¦¼ ì •ì˜ (variant playlist êµ¬ì„±ìš©)
            hls_variant _720p2628kbs BANDWIDTH=2628000,RESOLUTION=1280x720;
            hls_variant _480p1128kbs BANDWIDTH=1128000,RESOLUTION=854x480;
            hls_variant _360p878kbs  BANDWIDTH=878000, RESOLUTION=640x360;
            hls_variant _240p528kbs  BANDWIDTH=528000, RESOLUTION=426x240;
            hls_variant _240p264kbs  BANDWIDTH=264000, RESOLUTION=426x240;
        }
    }
}

# HTTP ìš”ì²­ ì²˜ë¦¬ ë¸”ë¡ (m3u8 ì œê³µ, API proxy ë“±)
http {
    root /www/static;               # ê¸°ë³¸ ì •ì  íŒŒì¼ ë£¨íŠ¸
    sendfile off;
    tcp_nopush on;
    server_tokens off;             # ë²„ì „ ê°ì¶”ê¸°
    access_log /dev/stdout combined;

    server {
        listen 80;                 # HTTP ê¸°ë³¸ í¬íŠ¸

        # ğŸ“Œ Spring ì„œë²„ì˜ ì—…ë¡œë“œ APIë¥¼ í”„ë¡ì‹œ ì²˜ë¦¬
        location /video/ {
            proxy_pass http://localhost:8080;            # Spring Boot ì„œë²„ì— ìš”ì²­ ì „ë‹¬
            client_max_body_size 10G;                    # ìµœëŒ€ ì—…ë¡œë“œ ìš©ëŸ‰ 10GBë¡œ ì„¤ì •
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ğŸ“º m3u8 ë° ts ìŠ¤íŠ¸ë¦¼ ì œê³µ (hls_path ê²½ë¡œ ë§¤í•‘)
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /opt/data;                              # ì‹¤ì œ ê²½ë¡œ: /opt/data/hls/...
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;    # CORS í—ˆìš©
        }

        # ğŸ¥ ê°„ëµí•œ ê²½ë¡œ ì ‘ê·¼ìš© (ì˜ˆ: /live/stream_key_720p/... ë¡œ ì ‘ì†)
        location /live {
            alias /opt/data/hls;                         # ì‹¤ì œ HLS ì €ì¥ ìœ„ì¹˜
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        # ğŸ“Š RTMP í†µê³„ ë·° (ì›¹ìœ¼ë¡œ ìƒíƒœ í™•ì¸)
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;               # /stat.xsl ì‚¬ìš©
        }

        # ğŸ“„ RTMP í†µê³„ìš© ìŠ¤íƒ€ì¼ ì‹œíŠ¸
        location /stat.xsl {
            root /www/static;
        }

        # Flash crossdomain í—ˆìš© (í•„ìš” ì‹œ)
        location /crossdomain.xml {
            default_type text/xml;
            expires 24h;
        }
    }
}
